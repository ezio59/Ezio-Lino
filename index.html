<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ezio/Lino - Gestore Spese Condivise</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-success {
            animation: pulseSuccess 0.5s ease-in-out;
        }
        @keyframes pulseSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: #10b981; }
            100% { transform: scale(1); }
        }
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .connection-status {
            transition: all 0.3s ease;
        }
        .offline {
            background-color: #ef4444;
        }
        .online {
            background-color: #10b981;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-calculator text-3xl"></i>
                    <h1 class="text-2xl md:text-3xl font-bold">Ezio/Lino</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connectionStatus" class="connection-status px-3 py-1 rounded-full text-sm font-medium">
                        <i class="fas fa-wifi mr-1"></i>
                        <span id="statusText">Connessione...</span>
                    </div>
                    <button id="settingsBtn" class="p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-colors">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Room Selection -->
        <div id="roomSelection" class="max-w-md mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-6 fade-in">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">
                    <i class="fas fa-door-open mr-2"></i>
                    Accesso Stanza
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Codice Stanza
                        </label>
                        <input type="text" id="roomCode" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Inserisci il codice della stanza">
                    </div>
                    
                    <div class="flex space-x-2">
                        <button id="joinRoom" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            Entra
                        </button>
                        <button id="createRoom" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>
                            Crea Nuova
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- App Interface -->
        <div id="appInterface" class="hidden">
            <!-- Room Info -->
            <div class="bg-white rounded-lg shadow-lg p-4 mb-6 fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">
                            <i class="fas fa-users mr-2"></i>
                            Stanza: <span id="currentRoom" class="text-blue-600"></span>
                        </h3>
                        <p class="text-sm text-gray-600">Condividi questo codice con i tuoi amici</p>
                    </div>
                    <div class="flex space-x-2">
                        <button id="shareRoom" class="bg-blue-100 text-blue-600 p-2 rounded-md hover:bg-blue-200 transition-colors">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <button id="leaveRoom" class="bg-red-100 text-red-600 p-2 rounded-md hover:bg-red-200 transition-colors">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Participants Section -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6 fade-in">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-user-friends mr-2"></i>
                    Partecipanti
                </h3>
                
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="participantName" 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Nome partecipante">
                    <button id="addParticipant" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <div id="participantsList" class="space-y-2">
                    <!-- Participants will be added here -->
                </div>
            </div>

            <!-- Add Expense Section -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6 fade-in">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-receipt mr-2"></i>
                    Aggiungi Spesa
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data</label>
                        <input type="date" id="expenseDate" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Importo (€)</label>
                        <input type="number" id="expenseAmount" step="0.01" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="0.00">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrizione</label>
                        <input type="text" id="expenseDescription" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Descrizione della spesa">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chi ha pagato</label>
                        <select id="expensePayer" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleziona chi ha pagato</option>
                        </select>
                    </div>
                    
                    <div class="flex items-end">
                        <button id="addExpense" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus-circle mr-2"></i>
                            Aggiungi Spesa
                        </button>
                    </div>
                </div>
            </div>

            <!-- Expenses List -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6 fade-in">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-list mr-2"></i>
                    Spese Registrate
                </h3>
                
                <div id="expensesList" class="space-y-3">
                    <!-- Expenses will be added here -->
                </div>
            </div>

            <!-- Balance Section -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6 fade-in">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-balance-scale mr-2"></i>
                    Bilancio e Rimborsi
                </h3>
                
                <div id="balanceSection" class="space-y-4">
                    <!-- Balance will be calculated here -->
                </div>
            </div>

            <!-- Export Section -->
            <div class="bg-white rounded-lg shadow-lg p-6 fade-in">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-download mr-2"></i>
                    Esporta Dati
                </h3>
                
                <div class="flex space-x-2">
                    <button id="exportData" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                        <i class="fas fa-file-export mr-2"></i>
                        Esporta Riassunto
                    </button>
                    <button id="clearData" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                        <i class="fas fa-trash mr-2"></i>
                        Cancella Tutto
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2">
        <!-- Toasts will be added here -->
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBkFZQRIhvTfCfK6qGnRBLqCOlgkJCEgWE",
            authDomain: "ezio-lino-expenses.firebaseapp.com",
            databaseURL: "https://ezio-lino-expenses-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "ezio-lino-expenses",
            storageBucket: "ezio-lino-expenses.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        let app, database, currentRoom = null;
        let participants = [];
        let expenses = [];
        let isOnline = navigator.onLine;

        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            updateConnectionStatus(true);
        } catch (error) {
            console.error('Firebase initialization error:', error);
            // Fallback to local storage
            updateConnectionStatus(false);
        }

        // DOM Elements
        const roomSelection = document.getElementById('roomSelection');
        const appInterface = document.getElementById('appInterface');
        const roomCodeInput = document.getElementById('roomCode');
        const joinRoomBtn = document.getElementById('joinRoom');
        const createRoomBtn = document.getElementById('createRoom');
        const currentRoomSpan = document.getElementById('currentRoom');
        const participantNameInput = document.getElementById('participantName');
        const addParticipantBtn = document.getElementById('addParticipant');
        const participantsList = document.getElementById('participantsList');
        const expenseForm = {
            date: document.getElementById('expenseDate'),
            amount: document.getElementById('expenseAmount'),
            description: document.getElementById('expenseDescription'),
            payer: document.getElementById('expensePayer')
        };
        const addExpenseBtn = document.getElementById('addExpense');
        const expensesList = document.getElementById('expensesList');
        const balanceSection = document.getElementById('balanceSection');

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            expenseForm.date.valueAsDate = new Date();
            
            // Load saved room from localStorage
            const savedRoom = localStorage.getItem('ezio-lino-room');
            if (savedRoom) {
                roomCodeInput.value = savedRoom;
            }

            // Event listeners
            setupEventListeners();
            
            // Check connection status
            window.addEventListener('online', () => {
                isOnline = true;
                updateConnectionStatus(true);
                if (currentRoom) {
                    // Sync offline data when back online
                    syncOfflineData();
                }
            });

            window.addEventListener('offline', () => {
                isOnline = false;
                updateConnectionStatus(false);
            });
        });

        function setupEventListeners() {
            // Room management
            createRoomBtn.addEventListener('click', createRoom);
            joinRoomBtn.addEventListener('click', joinRoom);
            document.getElementById('leaveRoom').addEventListener('click', leaveRoom);
            document.getElementById('shareRoom').addEventListener('click', shareRoom);

            // Participants
            addParticipantBtn.addEventListener('click', addParticipant);
            participantNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addParticipant();
                }
            });

            // Expenses
            addExpenseBtn.addEventListener('click', addExpense);
            
            // Export
            document.getElementById('exportData').addEventListener('click', exportData);
            document.getElementById('clearData').addEventListener('click', clearData);

            // Enter key on room code
            roomCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    joinRoom();
                }
            });
        }

        function createRoom() {
            const roomCode = generateRoomCode();
            roomCodeInput.value = roomCode;
            joinRoom();
        }

        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        function joinRoom() {
            const roomCode = roomCodeInput.value.trim().toUpperCase();
            if (!roomCode) {
                showToast('Inserisci un codice stanza', 'error');
                return;
            }

            currentRoom = roomCode;
            currentRoomSpan.textContent = roomCode;
            localStorage.setItem('ezio-lino-room', roomCode);

            // Hide room selection, show app
            roomSelection.classList.add('hidden');
            appInterface.classList.remove('hidden');

            // Load room data
            loadRoomData();
            
            showToast('Benvenuto nella stanza ' + roomCode, 'success');
        }

        function leaveRoom() {
            if (confirm('Sei sicuro di voler uscire dalla stanza?')) {
                currentRoom = null;
                participants = [];
                expenses = [];
                localStorage.removeItem('ezio-lino-room');
                
                // Show room selection, hide app
                roomSelection.classList.remove('hidden');
                appInterface.classList.add('hidden');
                
                // Clear inputs
                roomCodeInput.value = '';
                updateParticipantsList();
                updateExpensesList();
                updateBalance();
            }
        }

        function shareRoom() {
            if (navigator.share) {
                navigator.share({
                    title: 'Ezio/Lino - Codice Stanza',
                    text: `Unisciti alla stanza ${currentRoom} per condividere le spese!`,
                    url: window.location.href
                });
            } else {
                // Fallback: copy to clipboard
                const text = `Codice stanza Ezio/Lino: ${currentRoom}`;
                navigator.clipboard.writeText(text).then(() => {
                    showToast('Codice stanza copiato negli appunti!', 'success');
                });
            }
        }

        function addParticipant() {
            const name = participantNameInput.value.trim();
            if (!name) {
                showToast('Inserisci un nome valido', 'error');
                participantNameInput.classList.add('shake');
                setTimeout(() => participantNameInput.classList.remove('shake'), 500);
                return;
            }

            if (participants.includes(name)) {
                showToast('Questo partecipante è già presente', 'error');
                return;
            }

            participants.push(name);
            participantNameInput.value = '';
            updateParticipantsList();
            updatePayerSelect();
            saveRoomData();
            
            showToast(`${name} aggiunto con successo!`, 'success');
        }

        function removeParticipant(name) {
            if (confirm(`Rimuovere ${name} dalla lista?`)) {
                participants = participants.filter(p => p !== name);
                updateParticipantsList();
                updatePayerSelect();
                saveRoomData();
                showToast(`${name} rimosso dalla lista`, 'info');
            }
        }

        function updateParticipantsList() {
            participantsList.innerHTML = '';
            participants.forEach(name => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-md';
                div.innerHTML = `
                    <span class="font-medium">${name}</span>
                    <button onclick="removeParticipant('${name}')" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                participantsList.appendChild(div);
            });
        }

        function updatePayerSelect() {
            const select = expenseForm.payer;
            select.innerHTML = '<option value="">Seleziona chi ha pagato</option>';
            
            participants.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }

        function addExpense() {
            const date = expenseForm.date.value;
            const amount = parseFloat(expenseForm.amount.value);
            const description = expenseForm.description.value.trim();
            const payer = expenseForm.payer.value;

            // Validation
            if (!date || !amount || !description || !payer) {
                showToast('Completa tutti i campi', 'error');
                return;
            }

            if (amount <= 0) {
                showToast('L\'importo deve essere maggiore di zero', 'error');
                return;
            }

            const expense = {
                id: Date.now().toString(),
                date: date,
                amount: amount,
                description: description,
                payer: payer,
                timestamp: new Date().toISOString()
            };

            expenses.push(expense);
            
            // Clear form
            expenseForm.amount.value = '';
            expenseForm.description.value = '';
            expenseForm.payer.value = '';
            
            updateExpensesList();
            updateBalance();
            saveRoomData();
            
            showToast(`Spesa di €${amount.toFixed(2)} aggiunta!`, 'success');
        }

        function removeExpense(id) {
            if (confirm('Rimuovere questa spesa?')) {
                expenses = expenses.filter(e => e.id !== id);
                updateExpensesList();
                updateBalance();
                saveRoomData();
                showToast('Spesa rimossa', 'info');
            }
        }

        function updateExpensesList() {
            expensesList.innerHTML = '';
            
            if (expenses.length === 0) {
                expensesList.innerHTML = '<p class="text-gray-500 text-center py-4">Nessuna spesa registrata</p>';
                return;
            }

            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            expenses.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 rounded-md p-4 hover:bg-gray-50 transition-colors';
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${expense.description}</h4>
                            <p class="text-sm text-gray-600 mt-1">
                                <i class="fas fa-calendar mr-1"></i>
                                ${new Date(expense.date).toLocaleDateString('it-IT')}
                                <span class="mx-2">•</span>
                                <i class="fas fa-user mr-1"></i>
                                Pagato da ${expense.payer}
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-semibold text-green-600">€${expense.amount.toFixed(2)}</p>
                            <button onclick="removeExpense('${expense.id}')" class="text-red-600 hover:text-red-800 text-sm mt-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                expensesList.appendChild(div);
            });
        }

        function updateBalance() {
            balanceSection.innerHTML = '';
            
            if (participants.length === 0 || expenses.length === 0) {
                balanceSection.innerHTML = '<p class="text-gray-500 text-center py-4">Aggiungi partecipanti e spese per vedere il bilancio</p>';
                return;
            }

            // Calculate total and per person
            const total = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const perPerson = total / participants.length;

            // Calculate what each person paid
            const paid = {};
            participants.forEach(p => paid[p] = 0);
            expenses.forEach(exp => paid[exp.payer] += exp.amount);

            // Calculate balances
            const balances = {};
            participants.forEach(p => {
                balances[p] = paid[p] - perPerson;
            });

            // Display total
            const totalDiv = document.createElement('div');
            totalDiv.className = 'bg-blue-50 p-4 rounded-md mb-4';
            totalDiv.innerHTML = `
                <h4 class="font-semibold text-blue-900 mb-2">Totale Spese: €${total.toFixed(2)}</h4>
                <p class="text-blue-700">Quota per persona: €${perPerson.toFixed(2)}</p>
            `;
            balanceSection.appendChild(totalDiv);

            // Display individual balances
            const balanceDiv = document.createElement('div');
            balanceDiv.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-4';
            
            participants.forEach(person => {
                const balance = balances[person];
                const div = document.createElement('div');
                div.className = `p-4 rounded-md ${balance > 0 ? 'bg-green-50' : balance < 0 ? 'bg-red-50' : 'bg-gray-50'}`;
                div.innerHTML = `
                    <h5 class="font-medium">${person}</h5>
                    <p class="text-sm text-gray-600">Ha pagato: €${paid[person].toFixed(2)}</p>
                    <p class="text-sm ${balance > 0 ? 'text-green-600' : balance < 0 ? 'text-red-600' : 'text-gray-600'}">
                        ${balance > 0 ? `Deve ricevere: €${balance.toFixed(2)}` : 
                          balance < 0 ? `Deve pagare: €${Math.abs(balance).toFixed(2)}` : 'In pari'}
                    </p>
                `;
                balanceDiv.appendChild(div);
            });
            balanceSection.appendChild(balanceDiv);

            // Calculate and display transfers
            const transfers = calculateTransfers(balances);
            if (transfers.length > 0) {
                const transfersDiv = document.createElement('div');
                transfersDiv.className = 'bg-yellow-50 p-4 rounded-md';
                transfersDiv.innerHTML = '<h4 class="font-semibold text-yellow-900 mb-3">Rimborsi Necessari:</h4>';
                
                transfers.forEach(transfer => {
                    const p = document.createElement('p');
                    p.className = 'text-yellow-800 mb-1';
                    p.innerHTML = `<i class="fas fa-arrow-right mr-2"></i>${transfer.from} deve pagare €${transfer.amount.toFixed(2)} a ${transfer.to}`;
                    transfersDiv.appendChild(p);
                });
                
                balanceSection.appendChild(transfersDiv);
            }
        }

        function calculateTransfers(balances) {
            const creditors = [];
            const debtors = [];
            
            Object.entries(balances).forEach(([person, balance]) => {
                if (balance > 0.01) {
                    creditors.push({ person, amount: balance });
                } else if (balance < -0.01) {
                    debtors.push({ person, amount: Math.abs(balance) });
                }
            });

            const transfers = [];
            
            creditors.forEach(creditor => {
                debtors.forEach(debtor => {
                    if (creditor.amount > 0.01 && debtor.amount > 0.01) {
                        const amount = Math.min(creditor.amount, debtor.amount);
                        transfers.push({
                            from: debtor.person,
                            to: creditor.person,
                            amount: amount
                        });
                        creditor.amount -= amount;
                        debtor.amount -= amount;
                    }
                });
            });

            return transfers;
        }

        function saveRoomData() {
            if (!currentRoom) return;

            const roomData = {
                participants: participants,
                expenses: expenses,
                lastUpdated: new Date().toISOString()
            };

            // Save to localStorage
            localStorage.setItem(`ezio-lino-data-${currentRoom}`, JSON.stringify(roomData));

            // Save to Firebase if online
            if (isOnline && database) {
                try {
                    database.ref(`rooms/${currentRoom}`).set(roomData);
                } catch (error) {
                    console.error('Error saving to Firebase:', error);
                }
            }
        }

        function loadRoomData() {
            if (!currentRoom) return;

            // Try to load from Firebase first
            if (isOnline && database) {
                database.ref(`rooms/${currentRoom}`).once('value').then(snapshot => {
                    const data = snapshot.val();
                    if (data) {
                        participants = data.participants || [];
                        expenses = data.expenses || [];
                        updateParticipantsList();
                        updatePayerSelect();
                        updateExpensesList();
                        updateBalance();
                    } else {
                        // Load from localStorage if no Firebase data
                        loadFromLocalStorage();
                    }
                }).catch(error => {
                    console.error('Error loading from Firebase:', error);
                    loadFromLocalStorage();
                });

                // Listen for real-time updates
                database.ref(`rooms/${currentRoom}`).on('value', snapshot => {
                    const data = snapshot.val();
                    if (data) {
                        participants = data.participants || [];
                        expenses = data.expenses || [];
                        updateParticipantsList();
                        updatePayerSelect();
                        updateExpensesList();
                        updateBalance();
                    }
                });
            } else {
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem(`ezio-lino-data-${currentRoom}`);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    participants = data.participants || [];
                    expenses = data.expenses || [];
                    updateParticipantsList();
                    updatePayerSelect();
                    updateExpensesList();
                    updateBalance();
                } catch (error) {
                    console.error('Error loading from localStorage:', error);
                }
            }
        }

        function syncOfflineData() {
            if (!currentRoom || !database) return;

            const localData = localStorage.getItem(`ezio-lino-data-${currentRoom}`);
            if (localData) {
                try {
                    const data = JSON.parse(localData);
                    database.ref(`rooms/${currentRoom}`).set(data);
                    showToast('Dati sincronizzati con il cloud', 'success');
                } catch (error) {
                    console.error('Error syncing offline data:', error);
                }
            }
        }

        function updateConnectionStatus(online) {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (online) {
                statusElement.className = 'connection-status online px-3 py-1 rounded-full text-sm font-medium';
                statusText.textContent = 'Online';
            } else {
                statusElement.className = 'connection-status offline px-3 py-1 rounded-full text-sm font-medium';
                statusText.textContent = 'Offline';
            }
        }

        function exportData() {
            if (expenses.length === 0) {
                showToast('Nessun dato da esportare', 'error');
                return;
            }

            const total = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const perPerson = total / participants.length;

            let exportText = `EZIO/LINO - RESOCONTO SPESE\n`;
            exportText += `Stanza: ${currentRoom}\n`;
            exportText += `Data: ${new Date().toLocaleDateString('it-IT')}\n\n`;
            
            exportText += `PARTECIPANTI:\n`;
            participants.forEach(p => exportText += `- ${p}\n`);
            
            exportText += `\nSPESE:\n`;
            expenses.forEach(exp => {
                exportText += `${new Date(exp.date).toLocaleDateString('it-IT')} - ${exp.description} - €${exp.amount.toFixed(2)} (${exp.payer})\n`;
            });
            
            exportText += `\nRIASSUNTO:\n`;
            exportText += `Totale spese: €${total.toFixed(2)}\n`;
            exportText += `Quota per persona: €${perPerson.toFixed(2)}\n`;

            // Create and download file
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ezio-lino-${currentRoom}-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Resoconto esportato con successo!', 'success');
        }

        function clearData() {
            if (confirm('Sei sicuro di voler cancellare tutti i dati? Questa azione non può essere annullata.')) {
                participants = [];
                expenses = [];
                updateParticipantsList();
                updatePayerSelect();
                updateExpensesList();
                updateBalance();
                saveRoomData();
                showToast('Tutti i dati sono stati cancellati', 'info');
            }
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            
            toast.className = `${colors[type]} text-white px-4 py-2 rounded-md shadow-lg transform transition-all duration-300 translate-x-full`;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Global function to make removeParticipant available
        window.removeParticipant = removeParticipant;
        window.removeExpense = removeExpense;
    </script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDi0qKVLxM08PX7VSUl629WM4U8VStAydoidbQ1TnoLzvV4DiaOgcTYUDB2obMAH435HrG5BJ8iIb8NnZ3uKao%2FYbyZYpdZzoakr7QqKIhWkkk4E%2BMX7VvBGwlmjn7QTzshpNpHKL3UsFCoZhhdV1mi4683T1LLj7tZ9kYIj3sr4YGnnQL3noAvZkqkiSxIOeyetDA21QbqNBVevjx7tdNYGKelVhB6MLFK1xya%2B4TjHqQM7TiNI9W1psxsOUhkSbMIZl9Wamg1FXb9gMZbk940t1QgiIKRpDm%2Bxp8QiwR7fFnR8heVQm52JPyG1AeVeqx9Aadr2rCXuASmsCizK%2BzetjZpLmzJp90nba7Ccy3%2BcCtTxc0KkDR8ZrOIDCQ6Bq15cOj6SqtikPxEzCVTeaMCSnd62I55rsPom4O6PHsrRLMlM3RS4tEbrS%2BU21Mcx%2FBgou5iUaCQGoZV%2Fcq90snKk3ZlNSjYhyckTS%2B%2FDpET8%2F9zW%2B5mrnEHNvZJgagLtb0w%3D%3D";
        window.__genspark_locale = "it-IT";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDi0qKVLxM08PX7VSUl629WM4U8VStAydoidbQ1TnoLzvV4DiaOgcTYUDB2obMAH435HrG5BJ8iIb8NnZ3uKao/YbyZYpdZzoakr7QqKIhWkkk4E+MX7VvBGwlmjn7QTzshpNpHKL3UsFCoZhhdV1mi4683T1LLj7tZ9kYIj3sr4YGnnQL3noAvZkqkiSxIOeyetDA21QbqNBVevjx7tdNYGKelVhB6MLFK1xya+4TjHqQM7TiNI9W1psxsOUhkSbMIZl9Wamg1FXb9gMZbk940t1QgiIKRpDm+xp8QiwR7fFnR8heVQm52JPyG1AeVeqx9Aadr2rCXuASmsCizK+zetjZpLmzJp90nba7Ccy3+cCtTxc0KkDR8ZrOIDCQ6Bq15cOj6SqtikPxEzCVTeaMCSnd62I55rsPom4O6PHsrRLMlM3RS4tEbrS+U21Mcx/Bgou5iUaCQGoZV/cq90snKk3ZlNSjYhyckTS+/DpET8/9zW+5mrnEHNvZJgagLtb0w==";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    