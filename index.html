<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ezio/Lino - Gestore Spese Condivise</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }
        .connection-status {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .expense-item {
            transition: all 0.3s ease;
        }
        .expense-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        .balance-positive {
            color: #10b981;
        }
        .balance-negative {
            color: #ef4444;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background: #10b981;
        }
        .notification.error {
            background: #ef4444;
        }
        .notification.info {
            background: #3b82f6;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen py-8 px-4">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">
                <i class="fas fa-calculator mr-3"></i>Ezio/Lino
            </h1>
            <p class="text-white text-lg opacity-90">Gestore Spese Condivise</p>
            <div class="mt-4 flex justify-center items-center space-x-4">
                <div id="connectionStatus" class="flex items-center text-white">
                    <i class="fas fa-wifi mr-2"></i>
                    <span id="statusText">Connessione...</span>
                </div>
                <div id="syncStatus" class="flex items-center text-white" style="display: none;">
                    <i class="fas fa-sync-alt mr-2"></i>
                    <span>Sincronizzazione...</span>
                </div>
            </div>
        </div>

        <!-- Sezione Stanza -->
        <div class="card p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-home mr-2"></i>Gestione Stanza
            </h2>
            
            <div id="roomSelection" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Crea Nuova Stanza</label>
                        <button id="createRoomBtn" class="w-full btn-primary text-white py-3 px-6 rounded-lg font-semibold">
                            <i class="fas fa-plus mr-2"></i>Crea Stanza
                        </button>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Accedi a Stanza Esistente</label>
                        <div class="flex space-x-2">
                            <input type="text" id="roomCodeInput" placeholder="Codice stanza" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <button id="joinRoomBtn" class="btn-primary text-white px-6 py-2 rounded-lg font-semibold">
                                <i class="fas fa-sign-in-alt mr-2"></i>Accedi
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="roomInfo" class="mt-4 p-4 bg-purple-50 rounded-lg" style="display: none;">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-semibold text-purple-800">Stanza Attiva</h3>
                        <p class="text-purple-600">Codice: <span id="currentRoomCode" class="font-mono font-bold"></span></p>
                    </div>
                    <button id="leaveRoomBtn" class="text-red-600 hover:text-red-800 font-semibold">
                        <i class="fas fa-sign-out-alt mr-2"></i>Esci
                    </button>
                </div>
            </div>
        </div>

        <!-- Sezione Partecipanti -->
        <div id="participantsSection" class="card p-6 mb-6" style="display: none;">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-users mr-2"></i>Partecipanti
            </h2>
            
            <div class="flex space-x-2 mb-4">
                <input type="text" id="participantInput" placeholder="Nome partecipante" 
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <button id="addParticipantBtn" class="btn-primary text-white px-6 py-2 rounded-lg font-semibold">
                    <i class="fas fa-user-plus mr-2"></i>Aggiungi
                </button>
            </div>

            <div id="participantsList" class="space-y-2">
                <!-- Partecipanti dinamici -->
            </div>
        </div>

        <!-- Sezione Spese -->
        <div id="expensesSection" class="card p-6 mb-6" style="display: none;">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-receipt mr-2"></i>Aggiungi Spesa
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data</label>
                    <input type="date" id="expenseDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Importo (€)</label>
                    <input type="number" id="expenseAmount" step="0.01" placeholder="0.00" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Descrizione</label>
                <input type="text" id="expenseDescription" placeholder="Cosa hai pagato?" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Chi ha pagato?</label>
                    <select id="expensePayer" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">Seleziona chi ha pagato</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Dividi tra</label>
                    <div id="expenseParticipants" class="space-y-2">
                        <!-- Checkboxes dinamici -->
                    </div>
                </div>
            </div>

            <button id="addExpenseBtn" class="w-full btn-primary text-white py-3 px-6 rounded-lg font-semibold">
                <i class="fas fa-plus mr-2"></i>Aggiungi Spesa
            </button>
        </div>

        <!-- Sezione Spese Registrate -->
        <div id="expenseListSection" class="card p-6 mb-6" style="display: none;">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-list mr-2"></i>Spese Registrate
            </h2>
            
            <div id="expensesList" class="space-y-3">
                <!-- Spese dinamiche -->
            </div>
        </div>

        <!-- Sezione Rimborsi -->
        <div id="balanceSection" class="card p-6 mb-6" style="display: none;">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-balance-scale mr-2"></i>Bilanci e Rimborsi
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Bilanci Individuali</h3>
                    <div id="balanceList" class="space-y-2">
                        <!-- Bilanci dinamici -->
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Rimborsi Necessari</h3>
                    <div id="reimbursementList" class="space-y-2">
                        <!-- Rimborsi dinamici -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Sezione Azioni -->
        <div id="actionsSection" class="card p-6" style="display: none;">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-cogs mr-2"></i>Azioni
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button id="exportBtn" class="btn-primary text-white py-3 px-6 rounded-lg font-semibold">
                    <i class="fas fa-download mr-2"></i>Esporta Dati
                </button>
                <button id="refreshBtn" class="bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-semibold">
                    <i class="fas fa-refresh mr-2"></i>Aggiorna
                </button>
                <button id="clearBtn" class="bg-red-600 hover:bg-red-700 text-white py-3 px-6 rounded-lg font-semibold">
                    <i class="fas fa-trash mr-2"></i>Reset Stanza
                </button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        class EzioLinoApp {
            constructor() {
                this.currentRoom = null;
                this.roomData = {
                    participants: [],
                    expenses: []
                };
                this.binId = null;
                this.apiKey = 'replace-with-your-api-key'; // Placeholder - in produzione si userebbe una chiave reale
                this.syncInterval = null;
                this.isOnline = navigator.onLine;
                this.pendingActions = [];
                
                this.initializeApp();
                this.setupEventListeners();
                this.setupConnectionMonitoring();
            }

            initializeApp() {
                // Imposta la data di oggi
                document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
                
                // Carica dati locali se presenti
                this.loadLocalData();
                
                // Aggiorna stato connessione
                this.updateConnectionStatus();
            }

            setupEventListeners() {
                // Gestione stanza
                document.getElementById('createRoomBtn').addEventListener('click', () => this.createRoom());
                document.getElementById('joinRoomBtn').addEventListener('click', () => this.joinRoom());
                document.getElementById('leaveRoomBtn').addEventListener('click', () => this.leaveRoom());
                
                // Gestione partecipanti
                document.getElementById('addParticipantBtn').addEventListener('click', () => this.addParticipant());
                document.getElementById('participantInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addParticipant();
                });
                
                // Gestione spese
                document.getElementById('addExpenseBtn').addEventListener('click', () => this.addExpense());
                document.getElementById('roomCodeInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.joinRoom();
                });
                
                // Azioni
                document.getElementById('exportBtn').addEventListener('click', () => this.exportData());
                document.getElementById('refreshBtn').addEventListener('click', () => this.refreshData());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearRoom());
            }

            setupConnectionMonitoring() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateConnectionStatus();
                    this.processPendingActions();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateConnectionStatus();
                });
            }

            updateConnectionStatus() {
                const statusEl = document.getElementById('statusText');
                const connectionEl = document.getElementById('connectionStatus');
                
                if (this.isOnline) {
                    statusEl.textContent = 'Connesso';
                    connectionEl.className = 'flex items-center text-green-300';
                } else {
                    statusEl.textContent = 'Offline';
                    connectionEl.className = 'flex items-center text-red-300';
                }
            }

            async createRoom() {
                const roomCode = this.generateRoomCode();
                const roomData = {
                    code: roomCode,
                    participants: [],
                    expenses: [],
                    createdAt: new Date().toISOString()
                };

                try {
                    // Simula creazione su cloud (in produzione userebbe JSONBin.io)
                    const success = await this.saveToCloud(roomData);
                    
                    if (success) {
                        this.currentRoom = roomCode;
                        this.roomData = roomData;
                        this.showRoomInterface();
                        this.showNotification('Stanza creata con successo!', 'success');
                        this.startSyncInterval();
                    } else {
                        throw new Error('Errore nella creazione della stanza');
                    }
                } catch (error) {
                    this.showNotification('Errore nella creazione della stanza. Modalità offline attiva.', 'error');
                    // Modalità offline
                    this.currentRoom = roomCode;
                    this.roomData = roomData;
                    this.showRoomInterface();
                }
            }

            async joinRoom() {
                const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
                
                if (!roomCode) {
                    this.showNotification('Inserisci un codice stanza valido', 'error');
                    return;
                }

                try {
                    // Simula caricamento da cloud
                    const roomData = await this.loadFromCloud(roomCode);
                    
                    if (roomData) {
                        this.currentRoom = roomCode;
                        this.roomData = roomData;
                        this.showRoomInterface();
                        this.showNotification('Connesso alla stanza!', 'success');
                        this.startSyncInterval();
                    } else {
                        throw new Error('Stanza non trovata');
                    }
                } catch (error) {
                    // Prova a caricare da storage locale
                    const localData = this.loadLocalRoom(roomCode);
                    if (localData) {
                        this.currentRoom = roomCode;
                        this.roomData = localData;
                        this.showRoomInterface();
                        this.showNotification('Caricato da storage locale', 'info');
                    } else {
                        this.showNotification('Stanza non trovata', 'error');
                    }
                }
            }

            async saveToCloud(data) {
                if (!this.isOnline) {
                    this.saveToLocal(data);
                    return false;
                }

                try {
                    // Simulazione di salvataggio cloud
                    // In produzione, qui si userebbe JSONBin.io:
                    // const response = await fetch(`https://api.jsonbin.io/v3/b/${this.binId}`, {
                    //     method: 'PUT',
                    //     headers: {
                    //         'Content-Type': 'application/json',
                    //         'X-Master-Key': this.apiKey
                    //     },
                    //     body: JSON.stringify(data)
                    // });
                    
                    // Per ora salviamo localmente
                    this.saveToLocal(data);
                    return true;
                } catch (error) {
                    console.error('Errore salvataggio cloud:', error);
                    this.saveToLocal(data);
                    return false;
                }
            }

            async loadFromCloud(roomCode) {
                if (!this.isOnline) {
                    return this.loadLocalRoom(roomCode);
                }

                try {
                    // Simulazione caricamento cloud
                    // In produzione:
                    // const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                    //     headers: { 'X-Master-Key': this.apiKey }
                    // });
                    
                    // Per ora carichiamo localmente
                    return this.loadLocalRoom(roomCode);
                } catch (error) {
                    console.error('Errore caricamento cloud:', error);
                    return this.loadLocalRoom(roomCode);
                }
            }

            saveToLocal(data) {
                localStorage.setItem(`ezio_lino_${this.currentRoom}`, JSON.stringify(data));
                localStorage.setItem('ezio_lino_current_room', this.currentRoom);
            }

            loadLocalRoom(roomCode) {
                const data = localStorage.getItem(`ezio_lino_${roomCode}`);
                return data ? JSON.parse(data) : null;
            }

            loadLocalData() {
                const currentRoom = localStorage.getItem('ezio_lino_current_room');
                if (currentRoom) {
                    const roomData = this.loadLocalRoom(currentRoom);
                    if (roomData) {
                        this.currentRoom = currentRoom;
                        this.roomData = roomData;
                        this.showRoomInterface();
                    }
                }
            }

            generateRoomCode() {
                return Math.random().toString(36).substr(2, 6).toUpperCase();
            }

            showRoomInterface() {
                document.getElementById('roomSelection').style.display = 'none';
                document.getElementById('roomInfo').style.display = 'block';
                document.getElementById('currentRoomCode').textContent = this.currentRoom;
                
                // Mostra sezioni
                document.getElementById('participantsSection').style.display = 'block';
                document.getElementById('expensesSection').style.display = 'block';
                document.getElementById('expenseListSection').style.display = 'block';
                document.getElementById('balanceSection').style.display = 'block';
                document.getElementById('actionsSection').style.display = 'block';
                
                this.updateInterface();
            }

            leaveRoom() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                }
                
                this.currentRoom = null;
                this.roomData = { participants: [], expenses: [] };
                
                document.getElementById('roomSelection').style.display = 'block';
                document.getElementById('roomInfo').style.display = 'none';
                document.getElementById('participantsSection').style.display = 'none';
                document.getElementById('expensesSection').style.display = 'none';
                document.getElementById('expenseListSection').style.display = 'none';
                document.getElementById('balanceSection').style.display = 'none';
                document.getElementById('actionsSection').style.display = 'none';
                
                document.getElementById('roomCodeInput').value = '';
                localStorage.removeItem('ezio_lino_current_room');
            }

            addParticipant() {
                const input = document.getElementById('participantInput');
                const name = input.value.trim();
                
                if (!name) {
                    this.showNotification('Inserisci un nome valido', 'error');
                    return;
                }
                
                if (this.roomData.participants.includes(name)) {
                    this.showNotification('Partecipante già presente', 'error');
                    return;
                }
                
                this.roomData.participants.push(name);
                input.value = '';
                this.updateInterface();
                this.syncData();
                this.showNotification('Partecipante aggiunto!', 'success');
            }

            removeParticipant(name) {
                this.roomData.participants = this.roomData.participants.filter(p => p !== name);
                this.updateInterface();
                this.syncData();
                this.showNotification('Partecipante rimosso', 'info');
            }

            addExpense() {
                const date = document.getElementById('expenseDate').value;
                const amount = parseFloat(document.getElementById('expenseAmount').value);
                const description = document.getElementById('expenseDescription').value.trim();
                const payer = document.getElementById('expensePayer').value;
                
                if (!date || !amount || !description || !payer) {
                    this.showNotification('Compila tutti i campi', 'error');
                    return;
                }
                
                const participantCheckboxes = document.querySelectorAll('#expenseParticipants input[type="checkbox"]:checked');
                const participants = Array.from(participantCheckboxes).map(cb => cb.value);
                
                if (participants.length === 0) {
                    this.showNotification('Seleziona almeno un partecipante', 'error');
                    return;
                }
                
                const expense = {
                    id: Date.now(),
                    date,
                    amount,
                    description,
                    payer,
                    participants,
                    createdAt: new Date().toISOString()
                };
                
                this.roomData.expenses.push(expense);
                this.clearExpenseForm();
                this.updateInterface();
                this.syncData();
                this.showNotification('Spesa aggiunta!', 'success');
            }

            clearExpenseForm() {
                document.getElementById('expenseAmount').value = '';
                document.getElementById('expenseDescription').value = '';
                document.getElementById('expensePayer').value = '';
                document.querySelectorAll('#expenseParticipants input[type="checkbox"]').forEach(cb => cb.checked = false);
            }

            removeExpense(id) {
                this.roomData.expenses = this.roomData.expenses.filter(e => e.id !== id);
                this.updateInterface();
                this.syncData();
                this.showNotification('Spesa rimossa', 'info');
            }

            updateInterface() {
                this.updateParticipantsList();
                this.updateExpenseForm();
                this.updateExpensesList();
                this.updateBalances();
            }

            updateParticipantsList() {
                const container = document.getElementById('participantsList');
                container.innerHTML = '';
                
                this.roomData.participants.forEach(participant => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                    div.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-user mr-2 text-purple-600"></i>
                            <span class="font-medium">${participant}</span>
                        </div>
                        <button onclick="app.removeParticipant('${participant}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    container.appendChild(div);
                });
            }

            updateExpenseForm() {
                const payerSelect = document.getElementById('expensePayer');
                const participantsDiv = document.getElementById('expenseParticipants');
                
                // Aggiorna select pagatore
                payerSelect.innerHTML = '<option value="">Seleziona chi ha pagato</option>';
                this.roomData.participants.forEach(participant => {
                    const option = document.createElement('option');
                    option.value = participant;
                    option.textContent = participant;
                    payerSelect.appendChild(option);
                });
                
                // Aggiorna checkboxes partecipanti
                participantsDiv.innerHTML = '';
                this.roomData.participants.forEach(participant => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2';
                    label.innerHTML = `
                        <input type="checkbox" value="${participant}" checked class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                        <span class="text-sm">${participant}</span>
                    `;
                    participantsDiv.appendChild(label);
                });
            }

            updateExpensesList() {
                const container = document.getElementById('expensesList');
                container.innerHTML = '';
                
                if (this.roomData.expenses.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">Nessuna spesa registrata</p>';
                    return;
                }
                
                this.roomData.expenses.slice().reverse().forEach(expense => {
                    const div = document.createElement('div');
                    div.className = 'expense-item p-4 bg-gray-50 rounded-lg border';
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <i class="fas fa-receipt text-purple-600"></i>
                                    <span class="font-semibold">${expense.description}</span>
                                    <span class="text-gray-500 text-sm">${expense.date}</span>
                                </div>
                                <div class="text-sm text-gray-600 mb-2">
                                    Pagato da: <span class="font-semibold text-purple-600">${expense.payer}</span>
                                </div>
                                <div class="text-sm text-gray-600">
                                    Diviso tra: ${expense.participants.join(', ')}
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-lg font-bold text-green-600">€${expense.amount.toFixed(2)}</span>
                                <button onclick="app.removeExpense(${expense.id})" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            updateBalances() {
                const balances = this.calculateBalances();
                this.updateBalancesList(balances);
                this.updateReimbursementsList(balances);
            }

            calculateBalances() {
                const balances = {};
                
                // Inizializza bilanci
                this.roomData.participants.forEach(participant => {
                    balances[participant] = 0;
                });
                
                // Calcola bilanci per ogni spesa
                this.roomData.expenses.forEach(expense => {
                    const perPerson = expense.amount / expense.participants.length;
                    
                    // Il pagatore ha pagato per tutti
                    balances[expense.payer] += expense.amount;
                    
                    // Ogni partecipante deve la sua parte
                    expense.participants.forEach(participant => {
                        balances[participant] -= perPerson;
                    });
                });
                
                return balances;
            }

            updateBalancesList(balances) {
                const container = document.getElementById('balanceList');
                container.innerHTML = '';
                
                Object.entries(balances).forEach(([participant, balance]) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                    
                    const isPositive = balance > 0;
                    const balanceClass = isPositive ? 'balance-positive' : 'balance-negative';
                    const icon = isPositive ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
                    
                    div.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-user mr-2 text-purple-600"></i>
                            <span class="font-medium">${participant}</span>
                        </div>
                        <div class="flex items-center ${balanceClass}">
                            <i class="${icon} mr-2"></i>
                            <span class="font-bold">€${Math.abs(balance).toFixed(2)}</span>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            updateReimbursementsList(balances) {
                const container = document.getElementById('reimbursementList');
                container.innerHTML = '';
                
                const reimbursements = this.calculateReimbursements(balances);
                
                if (reimbursements.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">Nessun rimborso necessario</p>';
                    return;
                }
                
                reimbursements.forEach(reimbursement => {
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-blue-50 rounded-lg border border-blue-200';
                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-arrow-right text-blue-600"></i>
                                <span class="font-medium">${reimbursement.from}</span>
                                <span class="text-gray-500">→</span>
                                <span class="font-medium">${reimbursement.to}</span>
                            </div>
                            <span class="font-bold text-blue-600">€${reimbursement.amount.toFixed(2)}</span>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            calculateReimbursements(balances) {
                const reimbursements = [];
                const creditors = [];
                const debtors = [];
                
                // Separa creditori e debitori
                Object.entries(balances).forEach(([participant, balance]) => {
                    if (balance > 0.01) {
                        creditors.push({ name: participant, amount: balance });
                    } else if (balance < -0.01) {
                        debtors.push({ name: participant, amount: Math.abs(balance) });
                    }
                });
                
                // Calcola rimborsi ottimali
                while (creditors.length > 0 && debtors.length > 0) {
                    const creditor = creditors[0];
                    const debtor = debtors[0];
                    
                    const amount = Math.min(creditor.amount, debtor.amount);
                    
                    reimbursements.push({
                        from: debtor.name,
                        to: creditor.name,
                        amount: amount
                    });
                    
                    creditor.amount -= amount;
                    debtor.amount -= amount;
                    
                    if (creditor.amount < 0.01) {
                        creditors.shift();
                    }
                    if (debtor.amount < 0.01) {
                        debtors.shift();
                    }
                }
                
                return reimbursements;
            }

            syncData() {
                if (this.currentRoom) {
                    this.saveToCloud(this.roomData);
                }
            }

            startSyncInterval() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                }
                
                this.syncInterval = setInterval(() => {
                    if (this.isOnline && this.currentRoom) {
                        this.refreshData();
                    }
                }, 10000); // Sync ogni 10 secondi
            }

            async refreshData() {
                if (!this.currentRoom) return;
                
                try {
                    const updatedData = await this.loadFromCloud(this.currentRoom);
                    if (updatedData && JSON.stringify(updatedData) !== JSON.stringify(this.roomData)) {
                        this.roomData = updatedData;
                        this.updateInterface();
                        this.showNotification('Dati aggiornati!', 'info');
                    }
                } catch (error) {
                    console.error('Errore refresh:', error);
                }
            }

            exportData() {
                const data = {
                    room: this.currentRoom,
                    participants: this.roomData.participants,
                    expenses: this.roomData.expenses,
                    balances: this.calculateBalances(),
                    reimbursements: this.calculateReimbursements(this.calculateBalances()),
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ezio_lino_${this.currentRoom}_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showNotification('Dati esportati!', 'success');
            }

            clearRoom() {
                if (confirm('Sei sicuro di voler cancellare tutti i dati della stanza?')) {
                    this.roomData = { participants: [], expenses: [] };
                    this.updateInterface();
                    this.syncData();
                    this.showNotification('Stanza cancellata!', 'info');
                }
            }

            processPendingActions() {
                // Elabora azioni in sospeso quando torna online
                while (this.pendingActions.length > 0) {
                    const action = this.pendingActions.shift();
                    try {
                        action();
                    } catch (error) {
                        console.error('Errore elaborazione azione:', error);
                    }
                }
            }

            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }

        // Inizializza l'app
        const app = new EzioLinoApp();
        window.app = app; // Per debug
    </script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDg7Yb2PrIVOXW6FJh%2B6PzufUMBPmH25N5UB%2FF6OrXFVCXMvC%2FUV%2BtiCR9wv143e9UGAEs7PppGHc%2BbV19g4uIVIOQS8gGjPz%2FmvmoxO0zGu%2BurfDV5vtI6BQrhKeH3aOGHKJ6Lkg2a%2FaRahaT5%2BVmyWF0ERLlFKz7l1lmuMQt5HNOQID1SgC3GcKvN7Q%2BwGfjPQ4NANx%2B8uLMMUXz6l9QqG1mG8M2juS%2FqcYS%2BrdDxh87E%2BiFmFbLx%2BaFHn6rYbdMUXYHeFXTRKM033l5jh%2FsvLsd4Ugd6u02VSMDtO54TNO756%2FohoxkFzrxJAEpkriP8eURgLRG55%2B8J4VOnfGUJ6A5cmjsb1q1b7bkCVDPOOiZb3QCfWMGRW7U2zxwzIshctNM37C1uA2rRnENopQt%2BlEmqIB97JTXEUn%2BsJnidupp7sBMUZbe8mAZ%2FtpNCmJ6I2j0CkPjBFAP9f7tg0h2NJzReEskinGW9%2BQyip2QltBzjd7gXE5X03zb7MYMlfE2ud2mV%2BoYUuCGVDjYJ5O3ow%3D";
        window.__genspark_locale = "it-IT";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDg7Yb2PrIVOXW6FJh+6PzufUMBPmH25N5UB/F6OrXFVCXMvC/UV+tiCR9wv143e9UGAEs7PppGHc+bV19g4uIVIOQS8gGjPz/mvmoxO0zGu+urfDV5vtI6BQrhKeH3aOGHKJ6Lkg2a/aRahaT5+VmyWF0ERLlFKz7l1lmuMQt5HNOQID1SgC3GcKvN7Q+wGfjPQ4NANx+8uLMMUXz6l9QqG1mG8M2juS/qcYS+rdDxh87E+iFmFbLx+aFHn6rYbdMUXYHeFXTRKM033l5jh/svLsd4Ugd6u02VSMDtO54TNO756/ohoxkFzrxJAEpkriP8eURgLRG55+8J4VOnfGUJ6A5cmjsb1q1b7bkCVDPOOiZb3QCfWMGRW7U2zxwzIshctNM37C1uA2rRnENopQt+lEmqIB97JTXEUn+sJnidupp7sBMUZbe8mAZ/tpNCmJ6I2j0CkPjBFAP9f7tg0h2NJzReEskinGW9+Qyip2QltBzjd7gXE5X03zb7MYMlfE2ud2mV+oYUuCGVDjYJ5O3ow=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    
